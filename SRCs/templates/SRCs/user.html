{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Usuários Ativos</title>
    <link rel="stylesheet" href="{% static 'SRCs/css/usuarios.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

    {% include 'SRCs/menu_lateral_oculto.html' %}
    {% include 'SRCs/icone_user.html' %}

<div class="container">
    <h1 class="titulo">Usuários Ativos</h1>

    <table class="tabela-usuarios">
        <thead>
            <tr>
                <th><input type="checkbox" id="selectAll"></th>
                <th>Nome</th>
                <th>Email</th>
                <th>Cartão Postagem</th>
                <th>Grupo</th>
                <th>Unidade</th>
            </tr>
        </thead>
        <tbody>
    {% for usuario in usuarios %}
    <tr>
        <td><input type="checkbox" class="checkbox-user" data-id="{{ usuario.id }}"></td>
        <td>
            <img src="{% static 'SRCs/imagens/user-icon.png' %}" alt="Foto" class="user-photo">
            <span>{{ usuario.user.username }}</span>
        </td>
        <td>{{ usuario.user.email }}</td>
        <td>{{ usuario.cartao_postagem }}</td>
        <td>{{ usuario.perfil }}</td>
        <td>
            {% if usuario.unidade %}
                {{ usuario.unidade.nome }}
            {% else %}
                Sem unidade
            {% endif %}
        </td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="6" style="text-align:center;">Nenhum usuário ativo encontrado</td>
    </tr>
    {% endfor %}
</tbody>
    </table>

    <div class="acoes-tabela">
        <button id="btnEditar" class="btn" disabled><i class="fa fa-pen"></i> Editar</button>
        <button id="btnExcluir" class="btn excluir" disabled><i class="fa fa-trash"></i> Excluir</button>
    </div>
</div>

<!-- Modal Editar Usuário -->
<div id="modalEditar" class="modal" style="display:none;">
    <div class="modal-content">
        <span id="fecharModal" class="close">&times;</span>
        <h2>Editar Usuário</h2>
        <form id="formEditarUsuario">
            {% csrf_token %}
            <input type="hidden" name="usuario_id" id="usuarioId">

            <label>Nome:</label>
            <input type="text" name="username" id="username" required>

            <label>Email:</label>
            <input type="email" name="email" id="email" required>

            <label>Senha:</label>
            <input type="password" name="password" id="password" placeholder="Deixe em branco para não alterar">

            <label>Perfil:</label>
            <select name="perfil" id="perfil">
                <option value="Admin">Admin</option>
                <option value="Analista">Analista</option>
                <option value="Agente">Agente</option>
                <option value="Supervisor">Supervisor</option>
                <option value="Cliente">Cliente</option>
            </select>

            <label>Cartão Postagem:</label>
            <input type="text" name="cartao_postagem" id="cartaoPostagem" required>

            <button type="submit" class="btn salvar">Salvar</button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.checkbox-user');
    const btnEditar = document.getElementById('btnEditar');
    const btnExcluir = document.getElementById('btnExcluir');
    const modal = document.getElementById('modalEditar');
    const fecharModal = document.getElementById('fecharModal');
    const formEditar = document.getElementById('formEditarUsuario');

    function atualizarBotoes() {
        const selecionados = document.querySelectorAll('.checkbox-user:checked').length;
        btnEditar.disabled = selecionados !== 1;
        btnExcluir.disabled = selecionados === 0;
    }

    atualizarBotoes();

    selectAll.addEventListener('change', () => {
        checkboxes.forEach(chk => chk.checked = selectAll.checked);
        atualizarBotoes();
    });

    checkboxes.forEach(chk => {
        chk.addEventListener('change', () => {
            if (!chk.checked) selectAll.checked = false;
            else if (document.querySelectorAll('.checkbox-user:checked').length === checkboxes.length) {
                selectAll.checked = true;
            }
            atualizarBotoes();
        });
    });

    // ---- Editar ----
    btnEditar.addEventListener('click', () => {
        const selecionado = document.querySelector('.checkbox-user:checked');
        if (!selecionado) return;
        const usuarioId = selecionado.dataset.id;

        fetch(`/usuarios/detalhes/${usuarioId}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('usuarioId').value = data.id;
                document.getElementById('username').value = data.username;
                document.getElementById('email').value = data.email;
                document.getElementById('perfil').value = data.perfil;
                document.getElementById('cartaoPostagem').value = data.cartao_postagem;
                modal.style.display = 'flex';
            });
    });

    fecharModal.addEventListener('click', () => {
        modal.style.display = 'none';
    });

    formEditar.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(formEditar);

        fetch(`/usuarios/editar/${formData.get('usuario_id')}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            modal.style.display = 'none';
            location.reload();
        });
    });

    // ---- Excluir ----
    btnExcluir.addEventListener("click", () => {
        const selecionados = document.querySelectorAll(".checkbox-user:checked");
        if (selecionados.length === 0) return;

        if (!confirm("Realmente deseja excluir os usuários selecionados?")) return;

        const ids = Array.from(selecionados).map(chk => chk.dataset.id);

        fetch(`/usuarios/excluir/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({ ids })
        })
        .then(response => {
            if (response.ok) {
                alert("Usuário(s) excluído(s) com sucesso!");
                location.reload();
            } else {
                alert("Erro ao excluir usuário(s).");
            }
        })
        .catch(error => console.error("Erro:", error));
    });


    // Função utilitária para capturar o CSRF do cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>




</body>
</html>
