{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Usuários Ativos</title>
    <link rel="stylesheet" href="{% static 'SRCs/css/usuarios.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

    {% include 'SRCs/menu_lateral_oculto.html' %}
    {% include 'SRCs/icone_user.html' %}

<div class="container">
    <h1 class="titulo">Usuários Ativos</h1>

    <table class="tabela-usuarios">
        <thead>
            <tr>
                <th><input type="checkbox" id="selectAll"></th>
                <th>Nome</th>
                <th>Email</th>
                <th>Cartão Postagem</th>
                <th>Grupo</th>
                <th>Unidade</th>
            </tr>
        </thead>
        <tbody>
    {% for usuario in usuarios %}
    <tr>
        <td><input type="checkbox" class="checkbox-user" data-id="{{ usuario.id }}"></td>
        <td>
            {% if usuario.foto %}
                <img src="{{ usuario.foto.url }}" alt="Foto de {{ usuario.user.username }}" class="user-photo">
            {% else %}
                <img src="{% static 'SRCs/imagens/user-icon.png' %}" alt="Foto padrão" class="user-photo">
            {% endif %}
            <span>{{ usuario.user.username }}</span>
        </td>
        <td>{{ usuario.user.email }}</td>
        <td>{{ usuario.cartao_postagem }}</td>
        <td>{{ usuario.perfil }}</td>
        <td>
            {% if usuario.unidade %}
                {{ usuario.unidade.shopping }}
            {% else %}
                Sem unidade
            {% endif %}
        </td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="6" style="text-align:center;">Nenhum usuário ativo encontrado</td>
    </tr>
    {% endfor %}
</tbody>
    </table>

    <div class="acoes-tabela">
        <button id="btnEditar" class="btn" disabled><i class="fa fa-pen"></i> Editar</button>
        <button id="btnExcluir" class="btn excluir" disabled><i class="fa fa-trash"></i> Excluir</button>
    </div>
</div>

<!-- Modal Editar Usuário -->
<div id="modalEditar" class="modal" style="display:none;">
    <div class="modal-content">
        <span id="fecharModal" class="close">&times;</span>
        <h2>Editar Usuário</h2>
        <form id="formEditarUsuario">
            {% csrf_token %}
            <input type="hidden" name="usuario_id" id="usuarioId">

            <label>Nome:</label>
            <input type="text" name="username" id="username" required>

            <label>Email:</label>
            <input type="email" name="email" id="email" required>

            <label>Nova Senha:</label>
            <input type="password" name="password" id="password" placeholder="Deixe em branco para não alterar">
            <ul class="requisitos-senha">
                <li id="reqLength" style="color:red;">❌ Pelo menos 8 caracteres</li>
                <li id="reqLetter" style="color:red;">❌ Pelo menos 1 letra</li>
                <li id="reqNumber" style="color:red;">❌ Pelo menos 1 número</li>
                <li id="reqSpecial" style="color:red;">❌ Pelo menos 1 caractere especial (@$!%*?&)</li>
            </ul>

            <label>Confirmar Nova Senha:</label>
            <input type="password" name="confirmar_senha" id="confirmarSenha" placeholder="Repita a nova senha">
            <small id="matchMessage" style="display:none;"></small>

            <label>Perfil:</label>
            <select name="perfil" id="perfil">
                <option value="Admin">Admin</option>
                <option value="Analista">Analista</option>
                <option value="Agente">Agente</option>
                <option value="Supervisor">Supervisor</option>
                <option value="Cliente">Cliente</option>
            </select>

            <label>Cartão Postagem:</label>
            <input type="text" name="cartao_postagem" id="cartaoPostagem" required>

            <label>Unidade:</label>
            <select name="unidade" id="unidade" required>
                <option value="">--Selecione--</option>
                {% for u in unidades %}
                    <option value="{{ u.id }}">{{ u.shopping }}</option>
                {% endfor %}
            </select>

            <div class="botoes-form">
                <button type="button" id="btnLimpar" class="btn limpar">Limpar</button>
                <button type="submit" class="btn salvar">Salvar</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.checkbox-user');
    const btnEditar = document.getElementById('btnEditar');
    const btnExcluir = document.getElementById('btnExcluir');
    const modal = document.getElementById('modalEditar');
    const fecharModal = document.getElementById('fecharModal');
    const formEditar = document.getElementById('formEditarUsuario');
    const selectUnidade = document.getElementById('unidade');

    // Campos de senha
    const passwordInput = document.getElementById("password");
    const confirmInput = document.getElementById("confirmarSenha");
    const matchMessage = document.getElementById("matchMessage");

    const reqLength = document.getElementById("reqLength");
    const reqLetter = document.getElementById("reqLetter");
    const reqNumber = document.getElementById("reqNumber");
    const reqSpecial = document.getElementById("reqSpecial");

    const btnLimpar = document.getElementById("btnLimpar");

    function atualizarBotoes() {
        const selecionados = document.querySelectorAll('.checkbox-user:checked').length;
        btnEditar.disabled = selecionados !== 1;
        btnExcluir.disabled = selecionados === 0;
    }

    atualizarBotoes();

    selectAll.addEventListener('change', () => {
        checkboxes.forEach(chk => chk.checked = selectAll.checked);
        atualizarBotoes();
    });

    checkboxes.forEach(chk => {
        chk.addEventListener('change', () => {
            if (!chk.checked) selectAll.checked = false;
            else if (document.querySelectorAll('.checkbox-user:checked').length === checkboxes.length) {
                selectAll.checked = true;
            }
            atualizarBotoes();
        });
    });

    // ---- Editar ----
    btnEditar.addEventListener('click', async () => {
        const selecionado = document.querySelector('.checkbox-user:checked');
        if (!selecionado) return;
        const usuarioId = selecionado.dataset.id;

        const [usuarioResponse, unidadesResponse] = await Promise.all([
            fetch(`/usuarios/detalhes/${usuarioId}/`),
            fetch(`/unidades/listar/`)
        ]);

        const usuario = await usuarioResponse.json();
        const unidades = await unidadesResponse.json();

        document.getElementById('usuarioId').value = usuario.id;
        document.getElementById('username').value = usuario.username;
        document.getElementById('email').value = usuario.email;
        document.getElementById('perfil').value = usuario.perfil;
        document.getElementById('cartaoPostagem').value = usuario.cartao_postagem;

        selectUnidade.innerHTML = '<option value="">Selecione uma unidade</option>';
        unidades.forEach(u => {
            const opt = document.createElement('option');
            opt.value = u.id;
            opt.textContent = u.nome;
            if (usuario.unidade == u.id) opt.selected = true;
            selectUnidade.appendChild(opt);
        });

        modal.style.display = 'flex';
    });

    fecharModal.addEventListener('click', () => {
        modal.style.display = 'none';
    });

    formEditar.addEventListener('submit', (e) => {
        e.preventDefault();

        const senha = passwordInput.value;
        const confirmar = confirmInput.value;

        // Validação front-end antes de enviar
        if (senha) {
            const regex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
            if (!regex.test(senha)) {
                alert("A senha não atende aos requisitos.");
                return;
            }
            if (senha !== confirmar) {
                alert("As senhas não coincidem.");
                return;
            }
        }

        const formData = new FormData(formEditar);

        fetch(`/usuarios/editar/${formData.get('usuario_id')}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            modal.style.display = 'none';
            location.reload();
        });
    });


    // ---- Excluir ----
    btnExcluir.addEventListener("click", () => {
        const selecionados = document.querySelectorAll(".checkbox-user:checked");
        if (selecionados.length === 0) return;

        if (!confirm("Realmente deseja excluir os usuários selecionados?")) return;

        const ids = Array.from(selecionados).map(chk => chk.dataset.id);

        fetch(`/usuarios/excluir/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({ ids })
        })
        .then(response => {
            if (response.ok) {
                alert("Usuário(s) excluído(s) com sucesso!");
                location.reload();
            } else {
                alert("Erro ao excluir usuário(s).");
            }
        })
        .catch(error => console.error("Erro:", error));
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // ---- Validação de senha ----
    passwordInput.addEventListener("input", () => {
        const value = passwordInput.value;

        reqLength.style.color = value.length >= 8 ? "green" : "red";
        reqLength.textContent = value.length >= 8 ? "✔ Pelo menos 8 caracteres" : "❌ Pelo menos 8 caracteres";

        reqLetter.style.color = /[A-Za-z]/.test(value) ? "green" : "red";
        reqLetter.textContent = /[A-Za-z]/.test(value) ? "✔ Pelo menos 1 letra" : "❌ Pelo menos 1 letra";

        reqNumber.style.color = /\d/.test(value) ? "green" : "red";
        reqNumber.textContent = /\d/.test(value) ? "✔ Pelo menos 1 número" : "❌ Pelo menos 1 número";

        reqSpecial.style.color = /[@$!%*?&]/.test(value) ? "green" : "red";
        reqSpecial.textContent = /[@$!%*?&]/.test(value) ? "✔ Pelo menos 1 caractere especial (@$!%*?&)" : "❌ Pelo menos 1 caractere especial (@$!%*?&)";
    });

    confirmInput.addEventListener("input", () => {
        if (confirmInput.value === "") {
            matchMessage.style.display = "none";
        } else if (confirmInput.value === passwordInput.value) {
            matchMessage.style.display = "block";
            matchMessage.style.color = "green";
            matchMessage.textContent = "✔ As senhas coincidem";
        } else {
            matchMessage.style.display = "block";
            matchMessage.style.color = "red";
            matchMessage.textContent = "❌ As senhas não coincidem";
        }
    });

    btnLimpar.addEventListener("click", () => {
        formEditar.reset();

        reqLength.style.color = "red";
        reqLength.textContent = "❌ Pelo menos 8 caracteres";

        reqLetter.style.color = "red";
        reqLetter.textContent = "❌ Pelo menos 1 letra";

        reqNumber.style.color = "red";
        reqNumber.textContent = "❌ Pelo menos 1 número";

        reqSpecial.style.color = "red";
        reqSpecial.textContent = "❌ Pelo menos 1 caractere especial (@$!%*?&)";

        matchMessage.style.display = "none";
    });
});
</script>

</body>
</html>
