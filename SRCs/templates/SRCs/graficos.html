{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'SRCs/css/graficos.css' %}">
    <title>Dashboard de Envios</title>
</head>
<body>
    {% include 'SRCs/menu_lateral_oculto.html' %}
    {% include 'SRCs/icone_user.html' %}

    {% block content %}
    <h1>Dashboard de Envios</h1>

    <!-- Formulário de filtros -->
    <form method="get" class="filtro-form">
        <label for="data_inicial">Data inicial:</label>
        <input type="date" name="data_inicio" id="data_inicio" value="{{ request.GET.data_inicio }}">
        <label for="data_fim">Data final:</label>
        <input type="date" name="data_fim" id="data_fim" value="{{ request.GET.data_fim }}">
        <button type="submit">Filtrar</button>
    </form>

    <!-- Grid de gráficos -->
    <div class="graficos-grid">
        <div class="grafico-card">
            <h2>Quantidade de envios período</h2>
            <canvas id="graficoEnvios"></canvas>
        </div>
        <div class="grafico-card">
            <h2>Envios por lojas</h2>
            <canvas id="graficoRemetentes"></canvas>
        </div>
        <div class="grafico-card">
            <h2>Envios recebidos por loja</h2>
            <canvas id="graficoDestinatarios"></canvas>
        </div>
        <div class="grafico-card">
            <h2>Gastos por unidade</h2>
            <canvas id="graficoGastosUnidade"></canvas>
        </div>
        <div class="grafico-card">
            <h2>Quantidade de envios por usuário</h2>
            <canvas id="graficoEnviosUsuario"></canvas>
        </div>
    </div>

    <!-- Modal -->
    <div id="modalGrafico" class="modal-grafico">
        <div class="modal-grafico-content">
            <span id="fecharModal" class="modal-grafico-close">&times;</span>
            <canvas id="graficoModal"></canvas>
        </div>
    </div>

    {% endblock %}

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ===== Funções do modal =====
        const modal = document.getElementById('modalGrafico');
        const modalCanvas = document.getElementById('graficoModal');
        const fecharModal = document.getElementById('fecharModal');
        let graficoModalInstance = null;

        function abrirGraficoModal(chartInstance) {
            modal.classList.add('active');
            if (graficoModalInstance) graficoModalInstance.destroy();

            const config = {
                type: chartInstance.config.type,
                data: JSON.parse(JSON.stringify(chartInstance.data)),
                options: JSON.parse(JSON.stringify(chartInstance.options))
            };

            graficoModalInstance = new Chart(modalCanvas.getContext('2d'), config);
        }

        fecharModal.onclick = () => modal.classList.remove('active');
        modal.onclick = e => { if(e.target === modal) modal.classList.remove('active'); }

        // ===== Criação dos gráficos =====
        // Substitua os valores abaixo pelas variáveis do Django {{ ... }}

        const graficoEnvio = new Chart(document.getElementById('graficoEnvios').getContext('2d'), {
            type: 'bar',
            data: {
                labels: ['Jan', 'Fev', 'Mar', 'Abr'],
                datasets: [{ 
                    label: 'Envios por mês', 
                    data: [10, 20, 15, 25],
                    backgroundColor: 'rgba(54,162,235,0.6)',
                    borderColor: 'rgba(54,162,235,1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });

        const graficoRemetentes = new Chart(document.getElementById('graficoRemetentes').getContext('2d'), {
            type: 'bar',
            data: {
                labels: ['Loja A', 'Loja B', 'Loja C'],
                datasets: [{
                    label: 'Envios por loja',
                    data: [12, 8, 20],
                    backgroundColor: 'rgba(255,99,132,0.6)',
                    borderColor: 'rgba(255,99,132,1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, indexAxis: 'y', scales: { x: { beginAtZero: true } } }
        });

        const graficoDestinatarios = new Chart(document.getElementById('graficoDestinatarios').getContext('2d'), {
            type: 'bar',
            data: {
                labels: ['Loja X', 'Loja Y', 'Loja Z'],
                datasets: [{
                    label: 'Envios recebidos',
                    data: [5, 15, 10],
                    backgroundColor: 'rgba(75,192,192,0.6)',
                    borderColor: 'rgba(75,192,192,1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, indexAxis: 'y', scales: { x: { beginAtZero: true } } }
        });

        const graficoGastos = new Chart(document.getElementById('graficoGastosUnidade').getContext('2d'), {
            type: 'bar',
            data: {
                labels: ['Unidade 1', 'Unidade 2', 'Unidade 3'],
                datasets: [{
                    label: 'Gastos (R$)',
                    data: [200, 350, 150],
                    backgroundColor: 'rgba(54,162,235,0.6)',
                    borderColor: 'rgba(54,162,235,1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });

        const graficoUsuario = new Chart(document.getElementById('graficoEnviosUsuario').getContext('2d'), {
            type: 'bar',
            data: {
                labels: ['Usuário 1', 'Usuário 2', 'Usuário 3'],
                datasets: [{
                    label: 'Envios por usuário',
                    data: [7, 12, 9],
                    backgroundColor: 'rgba(255,159,64,0.6)',
                    borderColor: 'rgba(255,159,64,1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, indexAxis: 'y', scales: { x: { beginAtZero: true } } }
        });

        // ===== Eventos para abrir modal =====
        graficoEnvio.canvas.onclick = () => abrirGraficoModal(graficoEnvio);
        graficoRemetentes.canvas.onclick = () => abrirGraficoModal(graficoRemetentes);
        graficoDestinatarios.canvas.onclick = () => abrirGraficoModal(graficoDestinatarios);
        graficoGastos.canvas.onclick = () => abrirGraficoModal(graficoGastos);
        graficoUsuario.canvas.onclick = () => abrirGraficoModal(graficoUsuario);
    </script>
</body>
</html>
